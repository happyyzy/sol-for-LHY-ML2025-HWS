# Goal
本次作业的目标是：用sae-lens库等可视化工具研究google/gemma-2-2b-it，包括attention分布图，神经元激活情况等。

第一部分包含七块大问题，一部分列出在了[作业指导](https://speech.ee.ntu.edu.tw/~hylee/ml/ml2025-course-data//hw3.pdf)中，也是[我做的部分](hw3/2025_hw3.ipynb)；完整问题列在gradescope，没权限看不到。

第二部分是读论文回答8-9题，也看不到没法做。

没写问题回答，按[代码](hw3/2025_hw3.ipynb)里的输出自己看就好了。

# 自然语言生成练习题

## 问题 1 - 聊天模板比较 (1 分)
**任务描述：**  
观察使用/未使用聊天模板生成的回复。

**问题：**
- (0.2 + 0.2 分) 各自的连贯性分数是多少？（允许 0.5 的误差）  
  > 使用聊天模板分数：________  
  > 不使用聊天模板分数：________
- (0.3 分) 哪个分数更高？（选择题）  
  - [ ] 使用聊天模板更高  
  - [ ] 不使用聊天模板更高
- (0.3 分) 根据实验，从以下选项中选择正确的陈述，请精确选择 **2 个答案**。  
  - [ ] 选项 A  
  - [ ] 选项 B  
  - [ ] 选项 C  
  - [ ] 选项 D  

## 问题 2 - 多轮对话 (1 分)
**任务描述：**  
观察多轮对话的回复，检查模型回复的可能性及输入提示格式。

**问题：**
- (0.4 分) 提供第三轮正确的带有聊天模板格式的完整提示。  
  > 第三轮完整提示：________
- (0.2 分) 在第一轮（问题）中，概率最高的第一个令牌是什么？  
  > 第一个令牌：________
- (0.4 分) 根据实验，请从以下选项中选择错误的陈述。  
  - [ ] 选项 A  
  - [ ] 选项 B  
  - [ ] 选项 C  
  - [ ] 选项 D  

## 问题 3 - 句子的分词 (0.5 分)
**提示词：**  
"I love taking a Machine Learning course by Professor Hung-yi Lee, What about you?"

**问题：**
- 提示词是如何被分词的？请写出对应的令牌索引。  
  > 令牌 / 令牌索引：________
- (2 * 0.1 分 + 2 * 0.15 分) 写出对应的令牌 / 令牌索引。  
  > 令牌 / 索引：________

## 问题 4 - 自回归生成 (1.4 分)
**任务描述：**  
- 使用自回归生成方法生成 20 个句子  
- 计算 20 个句子的自BLEU分数  
- 比较 Top-k 采样 (k=2 vs k=200)  
- 比较 Top-p 采样 (p=0.6 vs p=0.999)  
- 观察流畅性、连贯性和多样性

**提示词：**  
"生成句子 'Professor Lee is one of the best teachers in the domain of machine learning' 的转述。只用一个句子回答。"

**问题：**
1. 关于自BLEU分数 (0.25 分)  
   请选择正确的陈述，你应该精确选择 **2 个答案**。  
   - [ ] 选项 A  
   - [ ] 选项 B  
   - [ ] 选项 C  
   - [ ] 选项 D

2. 关于 Top-p 和 Top-k (0.25 分)  
   请选择正确的陈述，你应该精确选择 **2 个答案**。  
   - [ ] 选项 A  
   - [ ] 选项 B  
   - [ ] 选项 C  
   - [ ] 选项 D

3. 当 k = 1 时，Top-k 生成的句子是什么？ (0.2 分)  
   > 答案：________

4. 当 p = 0 时，Top-p 生成的句子是什么？ (0.2 分)  
   > 答案：________

5. 比较不同 k 值 (2 vs 200) 下 Top-k 的自BLEU分数 (0.25 分)  
   哪个更高？为什么？  
   - [ ] k = 2 更高  
   - [ ] k = 200 更高  
   **理由：** ________

6. 比较不同 p 值 (0.6 vs 0.999) 下 Top-p 的自BLEU分数 (0.25 分)  
   哪个更高？为什么？  
   - [ ] p = 0.6 更高  
   - [ ] p = 0.999 更高  
   **理由：** ________

____________________
# 问题 5 - t-SNE (1 分)

**任务描述：**  
绘制 t-SNE 二维嵌入图。

**示例句子：**  
- "I ate a fresh apple."  # Apple (水果)  
- "Apple released the new iPhone."  # Apple (公司)  
- "I peeled an orange and ate it."  # Orange (水果)  
- "The Orange network has great coverage."  # Orange (电信公司)  
- "Microsoft announced a new update."  # Microsoft (公司)  
- "Banana is my favorite fruit."  # Banana (水果)  

**问题：**  
1. (0.4 分) 关于 T-SNE，选择正确的陈述，你应该精确选择 **2 个答案**。  
   - [ ] 选项 A  
   - [ ] 选项 B  
   - [ ] 选项 C  
   - [ ] 选项 D

2. (0.3 分) 关于 Q5 中的实验，请选择正确的陈述。  
   - [ ] 选项 A  
   - [ ] 选项 B  
   - [ ] 选项 C  
   - [ ] 选项 D

3. (0.3 分) 关于 Q5 中的实验，请选择错误的陈述。  
   - [ ] 选项 A  
   - [ ] 选项 B  
   - [ ] 选项 C  
   - [ ] 选项 D

---

# 问题 6 - 注意力图 (0.8 分)

**任务描述：**  
绘制并观察注意力图的图像。

**提示：**  
- 输入文本："Google"  
- 生成令牌数：20  
- 推荐层索引：10  
- 推荐头索引：7  

**问题：**  
1. (0.2 分) 关于示例代码生成的注意力图，请从以下选项中选择正确的陈述。  
   - [ ] 选项 A  
   - [ ] 选项 B  
   - [ ] 选项 C  
   - [ ] 选项 D

2. (0.2 分) 关于示例代码生成的注意力图，请从以下选项中选择正确的陈述。  
   - [ ] 选项 A  
   - [ ] 选项 B  
   - [ ] 选项 C  
   - [ ] 选项 D

3. (0.2 分) 请判断以下陈述是真/假？  
   - [ ] 真  
   - [ ] 假

4. (0.2 分) 请判断以下陈述是真/假？  
   - [ ] 真  
   - [ ] 假
# 问题 7 - SAE 激活分析

## 问题 7-1 - 理解 SAE 中的激活 (0.5 分)

**问题：**  
基于 Gemma Scope 和 Neurompedia，特征 10004 表示什么？激活密度 (activations density) 表示什么？  
你应该精确选择 **3 个答案**。

- [ ] 选项 A  
- [ ] 选项 B  
- [ ] 选项 C  
- [ ] 选项 D  
- [ ] 选项 E  

---

## 问题 7-2, 7-3 - 最大激活比较 (0.6 分)

**提示句：**  
a. "时间旅行给了我纠正过去错误的机会，但它也伴随着一系列风险。"  
b. "我接受我的决定塑造了我的未来，虽然错误是不可避免的，但它们定义了我将成为谁。"

**问题：**  
1. (0.2 分) 从 Gemma 的稀疏自编码器 (SAE) 中获取两个提示的最大激活值并比较它们的大小。哪个更大？  
   - [ ] 提示 a 更大  
   - [ ] 提示 b 更大  

2. (0.4 分) 解释上述答案的原因，哪个是正确的？  
   - [ ] 选项 A  
   - [ ] 选项 B  
   - [ ] 选项 C  
   - [ ] 选项 D  

> **提示：** 你可以使用每个提示的激活分布来解释结果。

---

## 问题 7-4 ~ 7-6 - 层的激活分布 (0.6 分)

**提示句：**  
"随着技术的不断进步，时间旅行将成为现实。"

**问题：**  
(每题 0.2 分) 基于第 24 层中关于特征 10004 的每个令牌的激活，以下哪个陈述是正确的？  
- [ ] 选项 A  
- [ ] 选项 B  
- [ ] 选项 C  
- [ ] 选项 D  

---

## 问题 7-7 ~ 7-9 - 令牌的激活分布 (0.6 分)

**提示句：**  
"随着技术的不断进步，时间旅行将成为现实。"

**问题：**  
1. (0.2 分) 基于所有层的激活图，以下哪个陈述是错误的？  
   - [ ] 选项 A  
   - [ ] 选项 B  
   - [ ] 选项 C  
   - [ ] 选项 D  

2. (0.2 分) 请判断以下陈述是真/假？  
   - [ ] 真  
   - [ ] 假  

3. (0.2 分) 请判断以下陈述是真/假？  
   - [ ] 真  
   - [ ] 假  

# Remark

本次作业与 2024 ML HW7 相近。作业资源如下：  
- [完整问题列表](https://hackmd.io/@reu7cWRzREKcA7gfMs6hxw/SyOYywp6a)  
- [官方代码](https://colab.research.google.com/drive/1Xnz0GHC0yWO2Do0aAYBCq9zL45lbiRjM?usp=sharing)（保存了完整输出结果，无需自己跑，做起来方便很多）

---

## 作业分三部分

1. **Machine Translation Task**  
   - 使用中译英模型 `Helsinki-NLP/opus-mt-zh-en`  
   - 对一句话使用 **梯度方法** 和 **注意力权重** 生成输入-输出的热力图

2. **Sentence Completion Task**  
   - 使用 `GPT2-XL` base 模型  
   - 对生成下一词的过程中，对之前词的注意力分数使用 **梯度方法** 和 **注意力权重** 生成热力图

3. **LLM Explanation**  
   - 与 ChatGPT 对话，让其生成重要性分数或展示思考链  
   - 此部分没有代码，直接使用 LLM 的 Web 界面即可



